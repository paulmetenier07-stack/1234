name: Bot de Surveillance Travis

on:
  workflow_dispatch: # Permet de le lancer manuellement
  schedule:
    # Exécute le script toutes les 5 minutes
    - cron: '*/5 * * * *'

jobs:
  # ===========================================================
  # TÂCHE UNIQUE : SURVEILLER LA BOUTIQUE
  # ===========================================================
  monitor-shop:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Autorise à écrire

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Shop script (monitor_bot.py)
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python monitor_bot.py

      - name: Commit Shop changes
        run: |
          if [ -f "changes_detected.flag" ]; then
            echo "Changement boutique détecté, sauvegarde..."
            git config --global user.name 'github-actions-bot'
            git config --global user.email 'github-actions-bot@users.noreply.github.com'
            git add last_content.txt
            rm changes_detected.flag
            git commit -m "Mise à jour automatique du contenu de la boutique"
            git push
          else
            echo "Aucun changement boutique, pas de sauvegarde."
          fi
